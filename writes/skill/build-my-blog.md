<!-- title: 从零搭建一个静态博客系统 -->
<!-- summary: 分享如何使用 Node.js 和 Markdown 构建一个功能完整的静态博客，包括自动生成、代码高亮、移动端适配等特性 -->
<!-- date: 2025.01.15 -->
<!-- category: skill -->

# 从零搭建一个静态博客系统

## 为什么选择静态博客？

在这个 JAMstack（JavaScript、API、Markdown）时代，静态博客有很多优势：速度快、成本低、SEO 友好、易于部署。相比于动态博客，静态博客生成后就是纯 HTML 文件，可以直接部署到 GitHub Pages、Netlify 等免费托管服务上。

我选择自己搭建而不是使用现成的框架（如 Hexo、Jekyll），主要原因是希望完全掌控博客的样式和功能，同时学习构建系统的设计思路。

## 技术栈选择

核心依赖只有三个：
- **markdown-it**：将 Markdown 转换为 HTML
- **highlight.js**：代码语法高亮
- **Node.js 原生模块**：文件系统操作和 HTTP 服务器

不使用构建工具（如 Webpack、Vite），所有功能都用原生 Node.js 实现，保持项目的轻量级和可维护性。

## 项目架构设计

### 目录结构

```
blogs/
├── writes/          # Markdown 源文件
│   ├── life/       # 生活类文章
│   ├── skill/      # 技术类文章
│   └── english/    # 英语学习
├── src/            # 源代码和模板
│   ├── index.template.html  # 首页模板
│   ├── articles.template.html # 文章页模板
│   ├── index.css   # 首页样式
│   └── article.css # 文章页样式
└── dist/           # 构建输出
    ├── index.html  # 生成的首页
    └── writes/     # 生成的文章 HTML
```

### 核心设计理念

1. **约定优于配置**：文章按文件夹分类，文件名即 URL 路径
2. **模板驱动**：使用 HTML 模板 + 占位符替换，而非字符串拼接
3. **构建时生成**：所有内容在构建阶段生成静态 HTML，运行时零依赖

## 核心功能实现

### 1. Markdown 元数据解析

文章元数据支持两种格式：HTML 注释和 YAML Frontmatter。HTML 注释格式更直观，便于在 Markdown 编辑器中直接编辑：

```markdown
<!-- title: 文章标题 -->
<!-- summary: 文章摘要 -->
<!-- date: 2025.01.15 -->
<!-- category: skill -->
<!-- private: true -->
```

解析器会逐行读取文件开头，匹配 `<!-- key: value -->` 格式的注释，提取元数据。如果某个字段缺失，会使用默认值：
- 标题：优先使用元数据，否则提取第一个 H1 标题，最后使用文件名
- 分类：优先使用元数据，否则使用父文件夹名
- 日期：优先使用元数据，否则使用文件修改时间

### 2. 模板系统

采用模板占位符的方式，将通用结构抽离到 `articles.template.html` 中，占位符包括：
- `{{TITLE}}`：文章标题
- `{{DATE}}`：发布日期
- `{{CATEGORY_SUFFIX}}`：分类标签
- `{{TOC}}`：目录 HTML
- `{{CONTENT}}`：文章内容
- `{{INDEX_CSS}}` 和 `{{ARTICLE_CSS}}`：分别注入首页样式和文章样式

这样的设计让页面结构更清晰，修改样式时只需要编辑模板文件，所有文章页会自动更新。

### 3. 目录生成与锚点定位

目录（TOC）的生成分为两步：
1. **解析标题**：使用正则表达式匹配 HTML 中的 H1-H3 标签，提取标题文本
2. **生成锚点**：将标题文本转换为 URL 友好的 slug（如"从零搭建" → "cong-ling-da-jian"），并作为 id 添加到标题标签上

目录 HTML 采用嵌套的 `<ul>` 结构，根据标题层级（H1、H2、H3）自动缩进。同时实现了滚动监听（scrollspy），当前浏览位置对应的目录项会高亮显示。

### 4. 代码高亮

使用 `highlight.js` 进行服务端渲染（SSR），在构建阶段就完成代码高亮，而不是在浏览器中执行。这样做的好处是：
- 首屏加载更快，无需等待 JavaScript 执行
- SEO 友好，搜索引擎可以直接看到高亮后的代码
- 离线可用，不依赖 CDN

高亮样式文件会被复制到 `dist/writes/highlight/` 目录，文章页通过相对路径引用。

### 5. 移动端适配

移动端的适配主要体现在两个方面：

**目录导航**：桌面端显示固定侧边栏，移动端转换为右上角的"汉堡"图标。点击图标时，目录从左侧滑入，点击外部区域或目录项时自动收起。使用 CSS 的 `transform: translateX()` 实现平滑的滑动动画。

**返回顶部按钮**：在右下角显示一个圆形按钮，包含一个进度环，显示当前滚动进度。进度环使用 SVG 的 `stroke-dasharray` 实现，通过计算滚动百分比动态更新。

### 6. 图片懒加载

自动为所有图片添加 `loading="lazy"` 属性。使用正则表达式匹配所有 `<img>` 标签，如果标签中没有 `loading` 属性，就自动添加。这样可以提升页面加载性能，特别是文章包含多张图片时。

### 7. 代码复制功能

为每个代码块添加一个"复制"按钮，点击后使用 `navigator.clipboard` API 将代码复制到剪贴板。按钮使用绝对定位，位于代码块的右上角，点击后显示"已复制"反馈。

## 构建流程

构建脚本 `build.mjs` 的执行流程：

1. **清理输出目录**：删除之前的构建产物
2. **读取样式和模板**：一次性读取 CSS 文件和 HTML 模板，避免重复 I/O
3. **处理高亮样式**：复制 highlight.js 的 CSS 文件到输出目录
4. **遍历 Markdown 文件**：
   - 解析元数据
   - 检查 `private` 标记（如果为 true 则跳过）
   - 转换 Markdown 为 HTML
   - 生成目录和锚点
   - 应用模板生成最终 HTML
5. **生成文章索引**：创建 `writes.json`，包含所有文章的元数据，供首页使用
6. **生成首页**：读取 `index.template.html` 和 `programs.json`，注入文章列表和项目列表

## 本地开发服务器

`serve.mjs` 实现了一个简单的静态文件服务器：

- 随机端口：避免端口冲突
- 自动检测局域网 IP：方便在手机上预览
- SPA 路由支持：未找到的文件自动回退到 `index.html`

## 特色功能

### 私有文章

通过在 Markdown 文件开头添加 `<!-- private: true -->`，可以将文章标记为私有。构建时会跳过这些文件，不会生成 HTML，也不会出现在文章列表中。这对于草稿或未完成的文章很有用。

### 扁平化文件命名

文章文件按目录组织，但生成的 HTML 文件名是扁平的。例如 `writes/life/bike-to-tibet.md` 会生成 `life-bike-to-tibet.html`。这样既保持了源文件的组织结构，又避免了输出目录的嵌套，URL 更简洁。

### 自动摘要提取

如果文章没有提供 `summary` 元数据，会自动从正文的第一段提取摘要。提取时会跳过代码块和 Frontmatter，只保留纯文本，并限制长度为 140 个字符。

## 部署

使用 `gh-pages` 将 `dist` 目录部署到 GitHub Pages。一条命令即可完成构建和部署：

```bash
npm run deploy
```

## 总结

这个静态博客系统的核心价值在于**简单而强大**。没有复杂的概念，没有臃肿的依赖，所有的功能都是通过原生 Node.js 和简单的字符串处理实现的。对于想要学习构建系统原理的开发者来说，这是一个很好的起点。

未来可能的改进方向：
- 支持 RSS 订阅
- 添加搜索功能
- 支持文章标签系统
- 集成评论系统（如 Giscus）

但在当前阶段，这个系统已经足够满足个人博客的需求了。

